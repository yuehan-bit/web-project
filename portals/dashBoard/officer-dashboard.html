<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Officer Dashboard - NROTC</title>
    <link rel="stylesheet" href="../../css/dashboard1.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
    />
    <link  href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="../../img/Unit.jpg" alt="ROTC Logo" />
            <h2>PLV NROTC</h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>
        <div class="sidebar">
          <a href="../../index.html">
            <span class="material-icons-sharp">home</span>
            <h3>Home</h3>
          </a>
          <a href="#profile">
            <span class="material-icons-sharp">person</span>
            <h3>Profile</h3>
          </a>
          <a href="#schedule">
            <span class="material-icons-sharp">calendar_today</span>
            <h3>Schedule</h3>
          </a>
          <a href="#resource">
            <span class="material-icons-sharp">folder</span>
            <h3>Resources</h3>
          </a>
          <a href="#announcements">
            <span class="material-icons-sharp">notifications</span>
            <h3>Updates</h3>
          </a>
          <a href="#uploads">
            <span class="material-icons-sharp">upload_file</span>
            <h3>Upload</h3>
          </a>
          <a href="#search">
            <span class="material-icons-sharp">search</span>
            <h3>Search</h3>
          </a>
          <a href="#reports">
            <span class="material-icons-sharp">assessment</span>
            <h3>Reports</h3>
          </a>
          <a href="#tools">
            <span class="material-icons-sharp">admin_panel_settings</span>
            <h3>Admin</h3>
          </a>
          <a onclick="logout()">
            <span class="material-icons-sharp">logout</span>
            <h3>Sign Out</h3>
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main>
        <h1>Officer Dashboard</h1>
        <div class="dashboard-welcome card">
          <h2>Welcome, <span id="officer-name">Officer Reyes</span>!</h2>
          <p>Manage schedules, and resources efficiently.</p>
        </div>
        <!-- Top Stats Cards -->
        <div class="dashboard-cards">
          <div class="dashboard-card">
            <span class="material-icons-sharp card-icon">schedule</span>
            <h3>Training Hours</h3>
            <p class="card-value">42.5</p>
            <p class="card-desc">Total hours this month</p>
          </div>
          <div class="dashboard-card">
            <span class="material-icons-sharp card-icon">star</span>
            <h3>Leadership Score</h3>
            <p class="card-value">92</p>
            <p class="card-desc">Your current score</p>
          </div>
          <div class="dashboard-card">
            <span class="material-icons-sharp card-icon">fitness_center</span>
            <h3>Physical Fitness</h3>
            <p class="card-value">245</p>
            <p class="card-desc">Fitness points</p>
          </div>
        </div>
        <!-- Upcoming Events -->
        <section id="schedule" class="dashboard-section">
          <h2>Schedule</h2>
          <ul class="schedule-list" id="schedule-list"></ul>
        </section>

        <!-- Resources Section -->
        <section id="resource" class="dashboard-section">
          <h2>Resources</h2>
          <ul class="resource-list" id="resource-list"></ul>
        </section>

        <!-- Updates/Announcements Section -->
        <section id="announcements" class="dashboard-section">
          <h2>Updates</h2>
          <ul class="updates-list">
            <li>
              <span class="material-icons-sharp">campaign</span>
              <strong>May 18:</strong> Parade uniform inspection moved to May
              28.
            </li>
            <li>
              <span class="material-icons-sharp">campaign</span>
              <strong>May 15:</strong> New training materials uploaded in
              Resources.
            </li>
            <li>
              <span class="material-icons-sharp">campaign</span>
              <strong>May 10:</strong> Congratulations to Cadet Santos for top
              PT score!
            </li>
          </ul>
        </section>

        <!-- Upload Section -->
        <section id="uploads" class="dashboard-section">
          <h2>Upload a File</h2>
          <form
            id="upload-form"
            class="upload-form"
            enctype="multipart/form-data"
          >
            <label for="upload-file" class="upload-label">
              <span
                class="material-icons-sharp"
                style="font-size: 2rem; vertical-align: middle"
                >cloud_upload</span
              >
              <span id="file-label-text">Choose a file or drag it here</span>
              <input
                type="file"
                id="upload-file"
                name="upload-file"
                accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.png"
                required
                hidden
              />
            </label>
            <button type="submit" class="dashboard-link">Upload</button>
          </form>
          <p class="text-muted">Accepted formats: PDF, DOC, PPT, JPG, PNG</p>
          <p id="upload-status"></p>
        </section>

        <!-- Search Section -->
        <section id="search" class="dashboard-section">
          <h2>Search</h2>
          <form class="search-form">
            <input
              type="text"
              placeholder="Search cadets, instructors, or resources..."
            />
            <button type="submit" class="dashboard-link">Search</button>
          </form>
          <div class="search-results">
            <ul>
              <li>
                <span class="material-icons-sharp">person</span>
                Cadet Maria Santos â€“ 2nd Year, Marine Option
              </li>
              <li>
                <span class="material-icons-sharp">folder</span>
                Training Manual (PDF)
              </li>
            </ul>
          </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="dashboard-section">
          <h2>Reports</h2>
          <table class="dashboard-table">
            <thead>
              <tr>
                <th>Cadet</th>
                <th>Attendance</th>
                <th>PT Score</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Maria Santos</td>
                <td>98%</td>
                <td>92</td>
                <td>Excellent</td>
              </tr>
              <tr>
                <td>Juan Dela Cruz</td>
                <td>95%</td>
                <td>88</td>
                <td>Good</td>
              </tr>
              <tr>
                <td>Jose Rizal</td>
                <td>100%</td>
                <td>95</td>
                <td>Outstanding</td>
              </tr>
            </tbody>
          </table>
        </section>

        <!-- Admin Section -->
        <section id="tools" class="dashboard-section">
          <h2>Admin</h2>
          <ul class="admin-tools-list">
            <li>
              <span class="material-icons-sharp">person_add</span>
              <a href="#">Add New Cadet</a>
            </li>
            <li>
              <span class="material-icons-sharp">edit</span>
              <a href="#">Edit Instructor Profiles</a>
            </li>
            <li>
              <span class="material-icons-sharp">settings</span>
              <a href="#">System Settings</li>
            <li>
              <span class="material-icons-sharp">backup</span>
              <a href="#">Backup Data</a>
            </li>
          </ul>
        </section>

        <!-- Contact Messages Section -->
        <section id="contact-messages" class="dashboard-section">
          <h2>Contact Messages</h2>
          <ul id="messages-list"></ul>
        </section>
      </main>

      <!-- Right Section for Profile Card -->
        <div class="right-section">
            <!-- <div class="profile-section">
                <img src="../../img/default-profile.png" alt="Profile Picture" id="profile-pic">
                <input type="file" id="profile-pic-input" style="display:none;">
                <h2><span id="welcome-message">Officer</span></h2>
                <p>Unit Officer</p>
                <p>PLV NROTC</p>
            </div> -->
            <div class="profile-section">
                <h2>Reservist Information</h2>
                <div style="text-align:center; margin-bottom:1rem;">
                    <img id="profile-pic" src="../../img/default-profile.png" alt="Profile Picture" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">
                    <br>
                    <input type="file" id="profile-pic-input" accept="image/*" style="margin-top:0.5rem;">
                </div>

                <!-- Cropper Modal -->
                <div id="cropper-modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
                  <div style="background:#fff;padding:1rem;border-radius:8px;max-width:90vw;max-height:90vh;">
                    <img id="cropper-image" style="max-width:80vw;max-height:60vh;">
                    <br>
                    <button id="crop-btn" style="margin-top:1rem;">Crop &amp; Use</button>
                    <button id="cancel-crop-btn" style="margin-top:1rem;">Cancel</button>
                  </div>
                </div>

                <button id="edit-profile-btn" class="dashboard-link" type="button">Edit</button>
                <div class="profile-table-wrapper">
                    <form id="profile-form">
                        <input type="hidden" name="profilePic" id="profile-pic-input-hidden">
                        <table class="profile-table">
                            <tr>
                                <th>Personnel Classification</th>
                                <td><input type="text" name="classification" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Rank</th>
                                <td><input type="text" name="rank" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>First Name</th>
                                <td><input type="text" name="firstName" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Middle Name</th>
                                <td><input type="text" name="middleName" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Last Name</th>
                                <td><input type="text" name="lastName" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Ext</th>
                                <td><input type="text" name="ext" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>AFPSN</th>
                                <td><input type="text" name="afpsn" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>BOS</th>
                                <td><input type="text" name="bos" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Classification</th>
                                <td><input type="text" name="class" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Mob Cen</th>
                                <td><input type="text" name="mobcen" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Source of Commission</th>
                                <td><input type="text" name="source" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Commission Category</th>
                                <td><input type="text" name="commissionCategory" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Birthday</th>
                                <td><input type="date" name="birthday" value="" disabled></td>
                            </tr>
                            <tr>
                                <th>Birthplace</th>
                                <td><input type="text" name="birthplace" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Sex</th>
                                <td><input type="text" name="sex" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Civil Status</th>
                                <td><input type="text" name="civilStatus" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Height (cm)</th>
                                <td><input type="number" name="height" value="" disabled></td>
                            </tr>
                            <tr>
                                <th>Weight (kg)</th>
                                <td><input type="number" name="weight" value="" disabled></td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td><input type="email" name="email" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Primary CP No.</th>
                                <td><input type="text" name="cp" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Present Address</th>
                                <td><input type="text" name="presentAddress" value="N/A" disabled></td>
                            </tr>
                            <tr>
                                <th>Permanent Address</th>
                                <td><input type="text" name="permanentAddress" value="N/A" disabled></td>
                            </tr>
                        </table>
                        <div style="margin-top:1rem; text-align:center;">
                            <button id="save-profile-btn" class="dashboard-link save-btn" type="submit" style="display:none;">
                                <span class="material-icons-sharp" style="vertical-align:middle;">save</span> Save
                            </button>
                            <button id="cancel-profile-btn" class="dashboard-link cancel-btn" type="button" style="display:none;">
                                <span class="material-icons-sharp" style="vertical-align:middle;">cancel</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Bar -->
    <nav class="mobile-navbar">
      <a href="../../index.html" class="active">
        <span class="material-icons-sharp">home</span>
      </a>
      <a href="profile/profile.html">
        <span class="material-icons-sharp">person</span>
      </a>
      <a href="training-schedule/training-schedule.html">
        <span class="material-icons-sharp">calendar_today</span>
      </a>
      <a href="resources/resources.html">
        <span class="material-icons-sharp">folder</span>
      </a>
      <a href="announcements/updates.html">
        <span class="material-icons-sharp">notifications</span>
      </a>
    </nav>

    <style>
      .upload-form {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 1em;
        margin-bottom: 1em;
      }
      .upload-label {
        display: flex;
        align-items: center;
        gap: 1em;
        background: #f5f7fa;
        border: 2px dashed #1976d2;
        border-radius: 8px;
        padding: 1em 2em;
        cursor: pointer;
        transition: background 0.2s, border 0.2s;
        width: 100%;
        max-width: 400px;
      }
      .upload-label.dragover {
        background: #e3f2fd;
        border-color: #1565c0;
      }
      .upload-label span {
        pointer-events: none;
      }
      .dashboard-link {
        background: #1976d2;
        color: #fff;
        border: none;
        padding: 0.5em 2em;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
      }
      .dashboard-link:hover {
        background: #1565c0;
      }
      .text-muted {
        color: #888;
        font-size: 0.95em;
      }
      #upload-status {
        font-weight: 500;
        margin-top: 0.5em;
      }
    </style>

    <script>
      // Logout Function
      function logout() {
        alert("Logging out...");
        window.location.href = "../../index.html";
      }

      // Profile Edit/Save/Cancel Logic
      document.addEventListener("DOMContentLoaded", function () {
        const editBtn = document.getElementById("edit-profile-btn");
        const saveBtn = document.getElementById("save-profile-btn");
        const cancelBtn = document.getElementById("cancel-profile-btn");
        const form = document.getElementById("profile-form");
        const inputs = form.querySelectorAll("input");

        let originalValues = {};

        editBtn.addEventListener("click", () => {
          inputs.forEach((input) => {
            originalValues[input.name] = input.value;
            input.disabled = false;
          });
          saveBtn.style.display = "";
          cancelBtn.style.display = "";
          editBtn.style.display = "none";
        });

        cancelBtn.addEventListener("click", () => {
          inputs.forEach((input) => {
            input.value = originalValues[input.name];
            input.disabled = true;
          });
          saveBtn.style.display = "none";
          cancelBtn.style.display = "none";
          editBtn.style.display = "";
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          inputs.forEach((input) => (input.disabled = true));
          saveBtn.style.display = "none";
          cancelBtn.style.display = "none";
          editBtn.style.display = "";
          alert("Profile updated!");
        });

        // Upload Section Logic
        const uploadForm = document.getElementById("upload-form");
        const fileInput = document.getElementById("upload-file");
        const label = document.querySelector(".upload-label");
        const labelText = document.getElementById("file-label-text");
        const status = document.getElementById("upload-status");

        // Show selected file name
        fileInput.addEventListener("change", function () {
          if (fileInput.files.length) {
            labelText.textContent = fileInput.files[0].name;
          } else {
            labelText.textContent = "Choose a file or drag it here";
          }
        });

        // Drag and drop support
        label.addEventListener("dragover", (e) => {
          e.preventDefault();
          label.classList.add("dragover");
        });
        label.addEventListener("dragleave", (e) => {
          e.preventDefault();
          label.classList.remove("dragover");
        });
        label.addEventListener("drop", (e) => {
          e.preventDefault();
          label.classList.remove("dragover");
          if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            labelText.textContent = fileInput.files[0].name;
          }
        });

        // Upload handler
        uploadForm.addEventListener("submit", function (e) {
          e.preventDefault();
          if (!fileInput.files.length) {
            status.textContent = "Please select a file.";
            return;
          }
          status.textContent = "Uploading...";
          const formData = new FormData(uploadForm);
          fetch("/api/upload", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              status.textContent = data.message || "Upload complete!";
              fileInput.value = "";
              labelText.textContent = "Choose a file or drag it here";
              if (typeof loadResources === "function") loadResources();
            })
            .catch(() => {
              status.textContent = "Upload failed.";
            });
        });
      });

      // Resources Section Logic
      async function loadResources() {
        const res = await fetch("/api/resources");
        const files = await res.json();
        const list = document.getElementById("resource-list");
        list.innerHTML = "";
        if (Array.isArray(files) && files.length > 0) {
          files.forEach((file) => {
            const li = document.createElement("li");
            li.innerHTML = `
                        <a href="/api/download/${file.filename}">
                            <span class="material-icons-sharp">download</span>
                            ${file.originalname}
                        </a>
                    `;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = "<li>No resources found.</li>";
        }
      }
      document.addEventListener("DOMContentLoaded", loadResources);
    </script>
    <script src="../../js/logged-in.js"></script>
    <script>
      //contact messages section
      async function loadContactMessages() {
        const res = await fetch("/api/contact/messages");
        const messages = await res.json();
        const list = document.getElementById("messages-list");
        list.innerHTML = "";
        if (Array.isArray(messages) && messages.length > 0) {
          messages.forEach((msg) => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${msg.name}</strong> (${msg.course})<br>
        <em>${new Date(msg.date).toLocaleString()}</em><br>
        ${msg.message}`;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = "<li>No messages yet.</li>";
        }
      }
      document.addEventListener("DOMContentLoaded", loadContactMessages);
    </script>
    <script>
      const username = sessionStorage.getItem("username");
      const form = document.getElementById("profile-form");
      const inputs = form.querySelectorAll("input");
      const editBtn = document.getElementById("edit-profile-btn");
      const saveBtn = document.getElementById("save-profile-btn");
      const cancelBtn = document.getElementById("cancel-profile-btn");
      let originalValues = {};

      // Load profile data
      async function loadProfile() {
        const res = await fetch(`/api/profile/${username}`);
        const data = await res.json();
        if (data) {
          for (const [key, value] of Object.entries(data)) {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) input.value = value;
          }
          if (data.profilePic) {
            picImg.src = data.profilePic;
            document.getElementById('profile-pic-input-hidden').value = data.profilePic;
          }
        }
        // Disable all fields by default
        inputs.forEach((input) => (input.disabled = true));
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
        editBtn.style.display = "";
      }
      document.addEventListener("DOMContentLoaded", loadProfile);

      editBtn.onclick = function () {
        inputs.forEach((input) => {
          originalValues[input.name] = input.value;
          input.disabled = false;
        });
        saveBtn.style.display = "";
        cancelBtn.style.display = "";
        editBtn.style.display = "none";
      };

      cancelBtn.onclick = function () {
        inputs.forEach((input) => {
          input.value = originalValues[input.name];
          input.disabled = true);
        });
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
        editBtn.style.display = "";
      };

      form.onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => (data[key] = value));
        await fetch(`/api/profile/${username}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        alert("Profile updated!");
        // After saving, disable fields and toggle buttons
        inputs.forEach((input) => (input.disabled = true));
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
        editBtn.style.display = "";
      };
    </script>
    <script>
let cropper;
const picInput = document.getElementById('profile-pic-input');
const picImg = document.getElementById('profile-pic');
const cropperModal = document.getElementById('cropper-modal');
const cropperImage = document.getElementById('cropper-image');
const cropBtn = document.getElementById('crop-btn');
const cancelCropBtn = document.getElementById('cancel-crop-btn');

picInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            cropperImage.src = e.target.result;
            cropperModal.style.display = 'flex';
            if (cropper) cropper.destroy();
            cropper = new Cropper(cropperImage, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 1
            });
        };
        reader.readAsDataURL(file);
    }
});

cropBtn.onclick = function() {
    if (cropper) {
        const canvas = cropper.getCroppedCanvas({
            width: 200,
            height: 200,
            imageSmoothingQuality: 'high'
        });
        const dataUrl = canvas.toDataURL();
        picImg.src = dataUrl;
        document.getElementById('profile-pic-input-hidden').value = dataUrl; // Save to hidden input
        document.getElementById('profile-pic-input-hidden').value = dataUrl;
        cropper.destroy();
        cropperModal.style.display = 'none';
        picInput.value = ""; // reset input
    }
};

cancelCropBtn.onclick = function() {
    if (cropper) cropper.destroy();
    cropperModal.style.display = 'none';
    picInput.value = ""; // reset input
};
</script>
    <script>
            // Load and display schedule for all users
      async function loadSchedule() {
        const res = await fetch('/api/schedule?_=' + Date.now());
        const schedule = await res.json();
        const list = document.getElementById('schedule-list');
        list.innerHTML = '';
        schedule.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${item.date}:</strong> ${item.activity} â€“ ${item.time}, ${item.location}`;
          list.appendChild(li);
        });
      }
      document.addEventListener('DOMContentLoaded', loadSchedule);
document.addEventListener('DOMContentLoaded', function() {
  fetch('/api/resources')
    .then(res => res.json())
    .then(files => {
      const list = document.getElementById('resource-list');
      list.innerHTML = '';
      if (Array.isArray(files) && files.length > 0) {
        files.forEach(file => {
          const li = document.createElement('li');
          li.innerHTML = `
            <a href="/api/download/${file.filename}">
              <span class="material-icons-sharp">download</span>
              ${file.originalname}
            </a>
          `;
          list.appendChild(li);
        });
      } else {
        list.innerHTML = '<li>No resources found.</li>';
      }
    })
    .catch(() => {
      const list = document.getElementById('resource-list');
      list.innerHTML = '<li>Failed to load resources.</li>';
    });
});
</script>
  </body>
</html>
